-- FILE-2db0326db4c0e6f669fd9a1253dd2e3: migrations/{{printf "%04d" .Extras.seq}}-{{snakeCase .ID}}.sql
-- Code generated by apigen. DO NOT EDIT.
-- GENERATED: {{now}}

{{- define "SqlTypeRef" -}}
  {{- if eq .Type "autoincrement" }}
    {{- "INTEGER" -}}
  {{- else if or (eq .Type "text" "password" "salt" "secret") }}
    {{- "VARCHAR(255)"}}
  {{- else if or (eq .Type "int" "version") }}
    {{- "INTEGER"}}
  {{- else if eq .Type "timestamp" }}
    {{- "DATETIME"}}
  {{- else }}
    {{- .Type}}
  {{- end}}
{{- end -}}

{{- define "SqlType" -}}
  {{- if eq .Type "autoincrement" }}
    {{- "INTEGER PRIMARY KEY AUTOINCREMENT" -}}
  {{- else }}
    {{- template "SqlTypeRef" .}}
  {{- end}}
{{- end }}

CREATE TABLE IF NOT EXISTS {{$Model := .}}{{ $idx := 0}}{{.Table}} (
  {{- "\n    "}}{{range .Fields -}}
    {{- $fb := .}}
    {{- if eq .Type "many-to-one" }}
      {{- $fidx := 0}}{{range .Extras.refKeys }}{{$fr := .}}
        {{- if eq $fidx 0}}
          {{- range $Model.Fields }}{{if eq .ID $fb.ID}}
            {{- if ge $idx 1}}{{ ",\n    " }}{{end}}{{$idx = add $idx 1}}
            {{- .Field}} {{ "" }}
            {{- range (model $Model .).Fields }}{{if eq .ID $fr.ref}}
              {{- template "SqlTypeRef" .}}
            {{- end}}{{end}}
          {{- end}}{{end}}
        {{- else}}
          {{- if ge $idx 1}}{{ ",\n    " }}{{end}}{{$idx = add $idx 1}}
          {{- .Field}} ({{.}})
        {{- end}}{{$fidx = add $fidx 1}}
      {{- end}}
    {{- else if eq .Type "many-to-many" }}
    {{- else }}
      {{- if ge $idx 1}}{{ ",\n    " }}{{end}}{{$idx = add $idx 1}}
      {{- .Field}} {{template "SqlType" .}}
    {{- end}}
  {{- end}}
  {{- range .Fields -}}
    {{- $fb := .}}
    {{- if eq .Type "many-to-one" }}
      {{- if ge $idx 1}}{{ ",\n    " }}{{end}}{{$idx = add $idx 1}}
      {{- "FOREIGN KEY("}}
      {{- $fidx := 0}}{{range .Extras.refKeys }}
        {{- .field}}
        {{- if gt $fidx 0}}, {{end}}{{$fidx = add $fidx 1}}
      {{- end}}) REFERENCES {{(model $Model .).Table}}(
      {{- $fidx := 0}}{{range .Extras.refKeys }}{{$fr := .}}
        {{- range $Model.Fields }}{{if eq .ID $fb.ID}}
          {{- range (model $Model .).Fields }}{{if eq .ID $fr.ref}}
            {{- .Field}}
          {{- end}}{{end}}
        {{- end}}{{end}}
      {{- end}})
    {{- end}}
  {{- end}}
);

{{- range .Fields -}}
  {{- if eq .Type "many-to-many" }}
-- FILE-2db0326db4c0e6f669fd9a1253dd2e3: migrations/{{printf "%04d" .Extras.seq}}-{{snakeCase $Model.ID}}-{{snakeCase .ID}}.sql
-- Code generated by apigen. DO NOT EDIT.
-- GENERATED: {{now}}

CREATE TABLE IF NOT EXISTS {{ $idx := 0}}{{.Extras.mapTable}} (
    {{- $idx := 0}}{{range (mapSelf $Model .)}}
      {{- if gt $idx 0}},{{end}}{{$idx = add $idx 1}}{{ "\n    "}}{{ .key.field}} {{ template "SqlTypeRef" .ref}}
    {{- end}}
    {{- range (mapRef $Model .)}}
      {{- if gt $idx 0}},{{end}}{{$idx = add $idx 1}}{{ "\n    "}}{{ .key.field}} {{ template "SqlTypeRef" .ref}}
    {{- end}}
    {{- ",\n    FOREIGN KEY (" -}}
    {{$fidx := 0}}{{- range (mapSelf $Model .)}}
      {{- if gt $fidx 0}}, {{end}}{{$fidx = add $fidx 1}}
      {{- .key.field}}
    {{- end}}) REFERENCES {{ "" -}}
    {{$fidx := 0}}{{- range (mapSelf $Model .)}}
      {{- if gt $fidx 0}}, {{else}}{{$Model.Table}} ({{end}}{{$fidx = add $fidx 1}}
      {{- .ref.Field}}
    {{- end}})
    {{- ",\n    FOREIGN KEY (" -}}
    {{$fidx := 0}}{{- range (mapRef $Model .)}}
      {{- if gt $fidx 0}}, {{end}}{{$fidx = add $fidx 1}}
      {{- .key.field}}
    {{- end}}) REFERENCES {{ "" -}}
    {{$fidx := 0}}{{- range (mapRef $Model .)}}
      {{- if gt $fidx 0}}, {{else}}{{.refModel.Table}} ({{end}}{{$fidx = add $fidx 1}}
      {{- .ref.Field}}
    {{- end}})
    {{- ",\n    UNIQUE (" }}
    {{- $fidx := 0}}{{- range (mapSelf $Model .)}}
      {{- if gt $fidx 0}}, {{end}}{{$fidx = add $fidx 1}}
      {{- .key.field}}
    {{- end}}
    {{- range (mapRef $Model .)}}
      {{- if gt $fidx 0}}, {{end}}{{$fidx = add $fidx 1}}
      {{- .key.field}}
    {{- end}})
);
  {{- end}}
{{- end}}
