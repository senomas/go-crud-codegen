{{ define "StoreImplFindFilter" -}}
// FILE-b2bab6a74adbe2e8dd47ebdcb76db7c4: model/gen__{{snakeCase .ID}}_store_find_filter.go
// Code generated by apigen. DO NOT EDIT.
// GENERATED: {{now}}

package {{.Package}}

import (
	"context"
	"database/sql"
	"encoding/json"
	"fmt"
	"log/slog"
	"strings"
	"{{.Module}}/util/jsql"
)

func filter_{{.ID}}(filter []{{.ID}}Filter) ([]string, []any, error) {
	qfilter := []string{}
	args := []any{}
  {{template "FilterOp" (dict "m" . "Res" "nil, nil, " )}}
  return qfilter, args, nil
}

{{- end}}

{{define "FilterOp_ILike" -}}
	var val {{.GoType}}
	err := json.Unmarshal(f.Value, &val)
	if err != nil {
    return {{.Args.Res}}err
  }
	args = append(args, val)
  qfilter = append(qfilter, fmt.Sprintf("obj.{{.Field}} ILIKE {{ template "QryParamArg" .}})
{{- end -}}

{{define "FilterOp" -}}
  {{- $m := .m -}}
  {{- $res := .Res -}}
  for _, f := range filter {
    switch f.Field {
    {{- range .m.Fields -}}{{if eq .Type "text"}}
    case {{$m.ID}}Field_{{.ID}}:
      switch f.Op {
      case FilterOp_EQ:
				var val {{.GoType}}
				err := json.Unmarshal(f.Value, &val)
				if err != nil {
          return {{$res}}err
        }
        {{- if eq .Case "upper" }}
          val = strings.ToUpper(val)
        {{- else if eq .Case "lower" }}
          val = strings.ToLower(val)
        {{- end}}
				args = append(args, val)
        qfilter = append(qfilter, fmt.Sprintf("obj.{{.Field}} = {{ template "QryParamArg" .}})
      case FilterOp_Like:
				var val {{.GoType}}
				err := json.Unmarshal(f.Value, &val)
				if err != nil {
          return {{$res}}err
        }
        {{- if eq .Case "upper" }}
          val = strings.ToUpper(val)
        {{- else if eq .Case "lower" }}
          val = strings.ToLower(val)
        {{- end}}
				args = append(args, val)
        qfilter = append(qfilter, fmt.Sprintf("obj.{{.Field}} LIKE {{ template "QryParamArg" .}})
      case FilterOp_ILike:
        {{- template "FilterOp_ILike" (fieldArgs . "Res" $res)}}
      default:
        return {{$res}}fmt.Errorf("unsupported filter op %v for field %v", f.Op, f.Field)
      }
    {{- else if eq .Type "integer" "timestamp" "date" "time"}}
    case {{$m.ID}}Field_{{.ID}}:
      switch f.Op {
      case FilterOp_EQ:
				var val {{.GoType}}
				err := json.Unmarshal(f.Value, &val)
				if err != nil {
          return {{$res}}err
        }
				args = append(args, val)
        qfilter = append(qfilter, fmt.Sprintf("obj.{{.Field}} = {{ template "QryParamArg" .}})
      case FilterOp_Greater:
				var val {{.GoType}}
				err := json.Unmarshal(f.Value, &val)
				if err != nil {
          return {{$res}}err
        }
				args = append(args, val)
        qfilter = append(qfilter, fmt.Sprintf("obj.{{.Field}} > {{ template "QryParamArg" .}})
      case FilterOp_GreaterEq:
				var val {{.GoType}}
				err := json.Unmarshal(f.Value, &val)
				if err != nil {
          return {{$res}}err
        }
				args = append(args, val)
        qfilter = append(qfilter, fmt.Sprintf("obj.{{.Field}} >= {{ template "QryParamArg" .}})
      case FilterOp_LessEq:
				var val {{.GoType}}
				err := json.Unmarshal(f.Value, &val)
				if err != nil {
          return {{$res}}err
        }
				args = append(args, val)
        qfilter = append(qfilter, fmt.Sprintf("obj.{{.Field}} <= {{ template "QryParamArg" .}})
      case FilterOp_Less:
				var val {{.GoType}}
				err := json.Unmarshal(f.Value, &val)
				if err != nil {
          return {{$res}}err
        }
				args = append(args, val)
        qfilter = append(qfilter, fmt.Sprintf("obj.{{.Field}} < {{ template "QryParamArg" .}})
      default:
        return {{$res}}fmt.Errorf("unsupported filter op %v for field %v", f.Op, f.Field)
      }
    {{- else if eq .Type "many-to-one"}}{{$fb := .}}
    {{- if eq (len .RefKeys) 1 }}
    {{- range .RefKeys -}}{{if eq .Ref.Type "text"}}
    case {{$m.ID}}Field_{{.ID}}:
      switch f.Op {
      case FilterOp_EQ:
				var val {{.Ref.GoType}}
				err := json.Unmarshal(f.Value, &val)
				if err != nil {
          return {{$res}}err
        }
        {{- if eq .Ref.Case "upper" }}
          val = strings.ToUpper(val)
        {{- else if eq .Ref.Case "lower" }}
          val = strings.ToLower(val)
        {{- end}}
				args = append(args, val)
        qfilter = append(qfilter, fmt.Sprintf("obj{{$fb.ID}}.{{.Field}} = {{ template "QryParamArg" .}})
      case FilterOp_Like:
				var val {{.Ref.GoType}}
				err := json.Unmarshal(f.Value, &val)
				if err != nil {
          return {{$res}}err
        }
        {{- if eq .Ref.Case "upper" }}
          val = strings.ToUpper(val)
        {{- else if eq .Ref.Case "lower" }}
          val = strings.ToLower(val)
        {{- end}}
				args = append(args, val)
        qfilter = append(qfilter, fmt.Sprintf("obj{{$fb.ID}}.{{.Field}} LIKE {{ template "QryParamArg" .}})
      case FilterOp_ILike:
        {{- template "FilterOp_ILike" (fieldArgs .Ref "Res" $res)}}
      default:
        return {{$res}}fmt.Errorf("unsupported filter op %v for field %v", f.Op, f.Field)
      }
    {{- end}}{{end}}{{end}}{{end}}{{end}}
    default:
      return {{$res}}fmt.Errorf("unsupported filter field %v", f.Field)
    }
  }
{{- end -}}

{{- define "PreFindObj"}}
  {{- range .Fields -}}
    {{- if eq .Type "text" }}
      {{- if eq .Case "upper" }}
        {{- "\n    "}}obj.{{.ID}} = strings.ToUpper(obj.{{.ID}}) 
      {{- else if eq .Case "lower" }}
        {{- "\n    "}}obj.{{.ID}} = strings.ToLower(obj.{{.ID}})
      {{- end}}
    {{- end}}
  {{- end}}
 {{- end -}}
