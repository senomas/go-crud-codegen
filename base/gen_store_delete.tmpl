{{ define "StoreImplDelete" -}}
// FILE-b2bab6a74adbe2e8dd47ebdcb76db7c4: model/gen__{{snakeCase .ID}}_store_delete.go
// Code generated by apigen. DO NOT EDIT.
// GENERATED: {{now}}

package {{.Package}}

import (
	"context"
	"database/sql"
	"encoding/json"
	"fmt"
	"log/slog"
	"strings"
	"{{.Module}}/util/jsql"
)

func (r *{{.ID}}StoreImpl) Delete(ctx context.Context, {{template "ParamFk" . }}) error {
  var tx *sql.Tx
  var err error
  var txNew bool
  tx, err = r.{{.DB}}.BeginTx(ctx, nil)
  if err != nil {
    return err
  }
  txNew = true
  qry := `
    DELETE FROM {{.Table}} obj WHERE
      {{ template "WhereFk" . }}`
  slog.Debug("store.{{.ID}}.Delete", "qry", qry,
    {{- range .PKeys -}}
      "{{.Field}}", {{.Name}},
    {{- end }}
  )
  res, err := tx.ExecContext(ctx, qry, {{ template "ArgFk" .}})
  if err != nil {
    slog.Error("store.{{.ID}}.Delete", "qry", qry,
      {{- range .PKeys -}}
        "{{.Field}}", {{.Name}},
      {{- end }}
    )
    return deleteError(err)
  }
  ra, err := res.RowsAffected()
  if err != nil {
    slog.Error("store.{{.ID}}.Delete.RowsAffected", "qry", qry,
      {{- range .PKeys -}}
        "{{.Field}}", {{.Name}},
      {{- end }}
    )
    return err
  }
  if ra == 0 {
    return fmt.Errorf("NO_ROWS_AFFECTED")
  }
  if ra != 1 {
    return fmt.Errorf("invalid rows affected (%d)", ra)
  }
  if txNew {
    err = tx.Commit()
    if err != nil {
      return err
    }
  }
  return nil
}
{{ end -}}
