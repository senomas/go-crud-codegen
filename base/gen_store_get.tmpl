{{ define "StoreImplGet" -}}
// FILE-b2bab6a74adbe2e8dd47ebdcb76db7c4: model/gen__{{snakeCase .ID}}_store_get.go
// Code generated by apigen. DO NOT EDIT.
// GENERATED: {{now}}

package {{.Package}}

import (
	"context"
	"database/sql"
	"encoding/json"
	"fmt"
	"log/slog"
	"strings"
	"{{.Module}}/util/jsql"
)

func (r *{{.ID}}StoreImpl) Get(ctx context.Context, {{template "ParamFk" . }}) (*{{.ID}}, error) {
  qry := "SELECT\n  "+r.qrySelectObj()+"\nFROM\n  "+r.qryFromObj()+"\nWHERE\n"+
    `{{ template "WhereFk" . }}`
  var obj {{.ID}};
  slog.Debug("store.{{.ID}}.Get", slog.String("qry", qry),
    {{- range .PKeys -}}
      {{.GoLogType}}("{{.Name}}", {{.Name}}),
    {{- end -}}
  )
  rows, err := r.{{.DB}}.QueryContext(ctx, qry, {{ template "ArgFk" . }})
  if err != nil {
    slog.Error("store.{{.ID}}.Get", slog.String("qry", qry),
      {{- range .PKeys -}}
        {{.GoLogType}}("{{.Name}}", {{.Name}}),
      {{- end -}}
    )
		return nil, err
	}
  defer rows.Close()
	if rows.Next() {
    err = r.scanObj(&obj, rows)
    if err != nil {
      slog.Error("store.{{.ID}}.Get.Scan",slog.String("qry", qry),
        {{- range .PKeys -}}
          {{.GoLogType}}("{{.Name}}", {{.Name}}),
        {{- end -}}
      )
      return nil, err
    }
  } else {
    return nil, fmt.Errorf("NOT_FOUND")
  }
  {{- range .Fields }}{{if eq .Type "many-to-many"}}
  obj.{{.ID}}, err = r.getObj_{{.ID}}(ctx, obj)
  if err != nil {
    return nil, err
  }
  {{- end}}{{end}}
  return &obj, err
}

{{range .Uniques -}}
func (r *{{.Model.ID}}StoreImpl) GetBy{{.ID}}(ctx context.Context, {{template "ParamUnique" . }}) (*{{.Model.ID}}, error) {
  qry := "SELECT\n  "+r.qrySelectObj()+"\nFROM\n  "+r.qryFromObj()+"\nWHERE\n  "+
    `{{ template "WhereUnique" . }}`
  var obj {{.Model.ID}};
  slog.Debug("store.{{.ID}}.Get", slog.String("qry", qry),
    {{- range .Fields -}}
      {{.GoLogType}}("{{.Name}}", {{.Name}}),
    {{- end -}}
  )
  rows, err := r.{{.Model.DB}}.QueryContext(ctx, qry, {{ template "ArgUnique" . }})
  if err != nil {
    slog.Error("store.{{.ID}}.Get", slog.String("qry", qry),
      {{- range .Fields -}}
        {{.GoLogType}}("{{.Name}}", {{.Name}}),
      {{- end -}}
    )
    return nil, err
  }
  defer rows.Close()
  if rows.Next() {
    err = r.scanObj(&obj, rows)
    if err != nil {
      slog.Error("store.{{.ID}}.Get", slog.String("qry", qry),
        {{- range .Fields -}}
          {{.GoLogType}}("{{.Name}}", {{.Name}}),
        {{- end -}}
      )
      return nil, err
    }
  } else {
    return nil, fmt.Errorf("NOT_FOUND")
  }
  {{- range .Model.Fields }}{{if eq .Type "many-to-many"}}
  obj.{{.ID}}, err = r.getObj_{{.ID}}(ctx, obj)
  if err != nil {
    return nil, err
  }
  {{- end}}{{end}}
  return &obj, nil
}
{{- end}}

func qrySelectCountObj_{{.ID}}() string {
 return `COUNT(DISTINCT
  {{ $idx := 0}}{{range .PKeys -}}{{- if gt $idx 0}}, {{end}}{{$idx = add $idx 1}}obj.{{.Field -}}
  {{- end}})`
}

func qrySelectObj_{{.ID}}() string {
  return `{{- $idx := 0}}{{range .Fields -}}
    {{- if eq .Type "many-to-one" }}{{$fb := . }}
      {{- range .RefKeys}}
        {{- if gt $idx 0}},{{ "\n      " }}{{end}}{{$idx = add $idx 1}}
        {{- "obj"}}{{$fb.ID}}.{{- .Ref.Field}}
      {{- end}}
      {{- range .RefFields}}
        {{- if gt $idx 0}},{{ "\n      " }}{{end}}{{$idx = add $idx 1}}
        {{- "obj"}}{{$fb.ID}}.{{- .Ref.Field}}
      {{- end}}
    {{- else if eq .Type "many-to-many" }}{{$fb := . }}
    {{-  else }}
      {{- if gt $idx 0}},{{ "\n      " }}{{end}}{{$idx = add $idx 1}}
      {{- "obj."}}{{.Field}}
    {{- end}}
  {{- end}}`
}


func qryFromObj_{{.ID}}() string {
  return `{{- $ridx:=0}}{{range .Fields -}}
    {{- if eq .Type "many-to-one" }}{{$fb := . }}
      {{- "("}}
    {{- end}}
   {{- end}}
  {{- .Table}} obj
  {{- range .Fields -}}
    {{- if eq .Type "many-to-one" }}{{$fb := . }}
      {{- if gt $ridx 0}}
        {{- "\n      LEFT JOIN "}}
      {{- else }}
        {{- " LEFT JOIN "}}
      {{- end}}{{ $ridx = add $ridx 1 }}
      {{- .RefModel.Table }} obj{{$fb.ID}}{{ " ON" -}}
      {{- range .RefKeys}}
        {{- " " }}obj.{{$fb.Field}} = obj{{$fb.ID}}.{{.Ref.Field}}
      {{- end}}
      {{- ")" }}
    {{- end}}
  {{- end}}`
}

func scanObj_{{.ID}}(obj *{{.ID}}, rows *sql.Rows) error {
  var err error
  {{ $idx:=0}}{{- range .Fields }}{{$f := . }}
    {{- if eq .Type "many-to-one" }}{{$fb := . }}
      {{- range .RefKeys}}
        {{- if gt $idx 0}}{{"\n  "}}{{end}}{{$idx = add $idx 1 -}}
        var ref{{$fb.ID}}_{{.Ref.ID}} {{.Ref.GoSqlNullType }}
      {{- end}}
      {{- range .RefFields}}
        {{- if gt $idx 0}}{{"\n  "}}{{end}}{{$idx = add $idx 1 -}}
        var ref{{$fb.ID}}_{{.Ref.ID}} {{.Ref.GoSqlNullType }}
      {{- end}}
    {{- end}}
  {{- end}}
  err = rows.Scan({{- range .Fields -}}{{$f := . -}}
    {{- if eq .Type "many-to-one" }}{{$fb := . }}
      {{- range .RefKeys}}
        &ref{{$fb.ID}}_{{.Ref.ID}},
      {{- end}}
      {{- range .RefFields}}
        &ref{{$fb.ID}}_{{.Ref.ID}},
      {{- end}}
    {{- else if eq .Type "many-to-many" }}{{$fb := . }}
    {{-  else }}
      &obj.{{.ID}},
    {{- end}}
  {{- end}})
  if err != nil {
    return err
  }
  {{- template "GetScanFieldPost" . }}
  {{- template "GetScanFieldRef" .}}
  return err
}

{{ range .Fields }}{{if eq .Type "many-to-many"}}
func getObj_{{.Model.ID}}_{{.ID}}(r *{{.Model.ID}}StoreImpl, ctx context.Context, obj {{.Model.ID}}) ([]{{.Ref}}, error) {
  var err error
  qry := `SELECT
  {{- $idx:=0}}{{range .RefKeys -}}
    {{- if gt $idx 0}}{{ "," }}{{end}}{{$idx = add $idx 1 -}}
    {{- "\n      "}}{{- .Ref.Field -}}
  {{- end -}}
  {{- range .RefFields -}}
    {{- if gt $idx 0}}{{ "," }}{{end}}{{$idx = add $idx 1 -}}
    {{- "\n      "}}{{- .Ref.Field -}}
  {{- end}}
    FROM
      {{.RefModel.Table}} obj JOIN {{.MapTable}} objRef ON
      {{- $idx:=0}}{{range .RefKeys -}}
        {{- if gt $idx 0}}{{ " AND " }}{{end}}{{$idx = add $idx 1 -}}
        {{- "\n        obj."}}{{.Ref.Field}} = objRef.{{.Field}}
      {{- end}}
    WHERE
      {{- $idx:=0}}{{range .MapKeys -}}
        {{- if gt $idx 0}}{{ " AND " }}{{end}}{{$idx = add $idx 1 -}}
        {{- "\n        objRef."}}{{.Field}} = ?
      {{- end -}}`
  slog.Debug("store.{{.ID}}.Get", slog.String("qry", qry),
    {{- range .MapKeys -}}
      {{.Ref.GoLogType}}("{{.ID}}", obj.{{.ID}}),
    {{- end -}}
  )
  rows, err := r.{{.Model.DB}}.QueryContext(ctx, qry
    {{- range .MapKeys -}}
      , obj.{{.ID}}
    {{- end -}}
  )
  if err != nil {
    return nil, err
  }
  defer rows.Close()
	var list []Role
  for rows.Next() {
    var ref {{.Ref}}
		err = rows.Scan(
    {{- range .RefKeys }}
			&ref.{{.ID}},
    {{- end}}
    {{- range .RefFields }}
			&ref.{{.ID}},
    {{- end}}
 		)
    if err != nil {
      return nil, err
    }
    list = append(list, ref)
  }
  return list, err
}
{{- end}}{{end}}

{{- end}}

{{- define "GetScanFieldPost" }}
  {{- range .Fields -}}
    {{- if eq .Type "timestamp" }}
      obj.{{.ID}} = util.AsZoneWallClock(obj.{{.ID}})
    {{- end}}
  {{- end}}
{{- end}}

{{- define "GetScanFieldRef" -}}
  {{- range .Fields -}}{{$f := . -}}
    {{- if eq .Type "many-to-one" }}{{$fb := . }}
      {{- if eq .Ref "User"}}
        {{- range .RefKeys}}
          if ref{{$fb.ID}}_{{.Ref.ID}}.Valid {
            if obj.{{$fb.ID}} == nil {
          	  obj.{{$fb.ID}} = &UserRef{ {{.Ref.ID}}: ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }}}
            } else {
          	  obj.{{$fb.ID}}.{{.Ref.ID}} = ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }}
            }
          }
        {{- end}}
        {{- range .RefFields}}
          if ref{{$fb.ID}}_{{.Ref.ID}}.Valid {
            obj.{{$fb.ID}}.{{.Ref.ID}} = ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }}
          }
        {{- end}}
      {{- else}}
        {{- range .RefKeys}}
          if ref{{$fb.ID}}_{{.Ref.ID}}.Valid {
            if obj.{{$fb.ID}} == nil {
          	  obj.{{$fb.ID}} = &{{.Ref.Model.ID}}{ {{.Ref.ID}}: ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }}}
            } else {
          	  obj.{{$fb.ID}}.{{.Ref.ID}} = ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }}
            }
          }
        {{- end}}
        {{- range .RefFields}}
          if ref{{$fb.ID}}_{{.Ref.ID}}.Valid {
            obj.{{$fb.ID}}.{{.Ref.ID}} = ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }}
          }
        {{- end}}
      {{- end}}
    {{- end}}
  {{- end}}
{{- end}}

{{- define "GetScanFieldManyRef" -}}
  {{- range .Fields -}}{{$f := . -}}
    {{- if eq .Type "many-to-one" }}{{$fb := . }}
    {{- else if eq .Type "many-to-many" }}{{$fb := . }}
      {{$fidx := 0}}{{- range .RefKeys }}
        if ref{{$fb.ID}}_{{.Ref.ID}}.Valid {
          {{- if gt $fidx 0}}
          if ref{{$fb.ID}} == nil {
            ref{{$fb.ID}} = &{{$fb.Ref}}{ {{.Ref.ID}}: ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }} }
          } else {
            ref{{$fb.ID}}.{{.Ref.ID}} = ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }}
          }
          {{- else}}
          ref{{$fb.ID}} = &{{$fb.Ref}}{ {{.Ref.ID}}: ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }} }
          {{- end}}{{$fidx = add $fidx 1}}
        }
      {{- end}}
      {{- range .RefFields }}
        if ref{{$fb.ID}} != nil && ref{{$fb.ID}}_{{.Ref.ID}}.Valid {
          ref{{$fb.ID}}.{{.Ref.ID}} = ref{{$fb.ID}}_{{.Ref.ID}}.{{.Ref.GoSqlNullValue }}
        }
      {{- end}}
      if ref{{$fb.ID}} != nil {
        obj.{{$fb.ID}} = append(obj.{{$fb.ID}}, *ref{{$fb.ID}})
        ref{{$fb.ID}} = nil
      }
    {{- end}}
  {{- end}}
{{- end}}

