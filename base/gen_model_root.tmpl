// FILE: model/gen___model.go
// Code generated by apigen. DO NOT EDIT.
// GENERATED: {{now}}

{{$idx:=0}}{{range .}}{{if eq $idx 0}}{{ $idx = 1 }}
package {{.Package}}
{{- end}}{{end}}

import (
	"database/sql"
	"encoding/json"
	"time"
)

type Store interface {
{{- range .}}
  {{.ID}}() {{.ID}}Store
{{- end}}
}

type FilterOp string

const (
	FilterOp_EQ        FilterOp = "eq"
	FilterOp_Like      FilterOp = "like"
	FilterOp_ILike     FilterOp = "ilike"
	FilterOp_Greater   FilterOp = "gt"
	FilterOp_Less      FilterOp = "lt"
	FilterOp_GreaterEq FilterOp = "gte"
	FilterOp_LessEq    FilterOp = "lte"
)

type SortDir string

const (
	SortDir_ASC  SortDir = "asc"
	SortDir_DESC SortDir = "desc"
)

type FilterFn func(qfilter []string, args []any, field string, op FilterOp, value json.RawMessage) ([]string, []any, error)

type FilterFieldFn func(qfilter []string, args []any, op FilterOp, value json.RawMessage) ([]string, []any, error)


var Filters = struct {
	Text    FilterFn
	Numeric FilterFn
	Time    FilterFn
}{
	Text:    filterText,
	Numeric: nil,
	Time:    filterTime,
}

{{ define "FilterStr" -}}
  fmt.Sprintf("{{ .fmt}}$%d", field, len(args))
{{- end }}

func filterText(qfilter []string, args []any, field string, op FilterOp, value json.RawMessage) ([]string, []any, error) {
	switch op {
	case FilterOp_EQ:
		var val string
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s = ") }})
	case FilterOp_Like:
		var val string
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s LIKE ")}})
	case FilterOp_ILike:
		var val string
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s LIKE ")}})
	default:
		return qfilter, args, fmt.Errorf("unsupported filter op %v for field %v", op, field)
	}
	return qfilter, args, nil
}

func filterTextUpper(qfilter []string, args []any, field string, op FilterOp, value json.RawMessage) ([]string, []any, error) {
	switch op {
	case FilterOp_EQ:
		var val string
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		val = strings.ToUpper(val)
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s = ")}})
	case FilterOp_Like:
		var val string
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		val = strings.ToUpper(val)
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s LIKE ")}})
	case FilterOp_ILike:
		var val string
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		val = strings.ToUpper(val)
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "UPPER(%s) LIKE ")}})
	default:
		return qfilter, args, fmt.Errorf("unsupported filter op %v for field %v", op, field)
	}
	return qfilter, args, nil
}

func filterTextLower(qfilter []string, args []any, field string, op FilterOp, value json.RawMessage) ([]string, []any, error) {
	switch op {
	case FilterOp_EQ:
		var val string
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		val = strings.ToLower(val)
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s = ")}})
	case FilterOp_Like:
		var val string
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		val = strings.ToLower(val)
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s LIKE ")}})
	case FilterOp_ILike:
		var val string
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		val = strings.ToLower(val)
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "LOWER(%s) LIKE ")}})
	default:
		return qfilter, args, fmt.Errorf("unsupported filter op %v for field %v", op, field)
	}
	return qfilter, args, nil
}

func filterNumeric(qfilter []string, args []any, field string, op FilterOp, value json.RawMessage) ([]string, []any, error) {
	switch op {
	case FilterOp_EQ:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s = ")}})
	case FilterOp_Greater:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s > ")}})
	case FilterOp_GreaterEq:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s >= ")}})
	case FilterOp_LessEq:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s <= ")}})
	case FilterOp_Less:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s < ")}})
	default:
		return qfilter, args, fmt.Errorf("unsupported filter op %v for field %v", op, field)
	}
	return qfilter, args, nil
}

func filterInt(qfilter []string, args []any, field string, op FilterOp, value json.RawMessage) ([]string, []any, error) {
	switch op {
	case FilterOp_EQ:
		var val int64
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s = ")}})
	case FilterOp_Greater:
		var val int64
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s > ")}})
	case FilterOp_GreaterEq:
		var val int64
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s >= ")}})
	case FilterOp_LessEq:
		var val int64
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s <= ")}})
	case FilterOp_Less:
		var val int64
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s < ")}})
	default:
		return qfilter, args, fmt.Errorf("unsupported filter op %v for field %v", op, field)
	}
	return qfilter, args, nil
}

func filterTime(qfilter []string, args []any, field string, op FilterOp, value json.RawMessage) ([]string, []any, error) {
	switch op {
	case FilterOp_EQ:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s = ")}})
	case FilterOp_Greater:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s > ")}})
	case FilterOp_GreaterEq:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s >= ")}})
	case FilterOp_LessEq:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s <= ")}})
	case FilterOp_Less:
		var val time.Time
		err := json.Unmarshal(value, &val)
		if err != nil {
			return qfilter, args, err
		}
		args = append(args, val)
		qfilter = append(qfilter, {{ template "FilterStr" (dict "fmt" "%s < ")}})
	default:
		return qfilter, args, fmt.Errorf("unsupported filter op %v for field %v", op, field)
	}
	return qfilter, args, nil
}
